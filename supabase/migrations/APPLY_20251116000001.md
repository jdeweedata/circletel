# How to Apply Migration: 20251116000001_enhance_product_integrations_tracking

## Migration File
`supabase/migrations/20251116000001_enhance_product_integrations_tracking.sql`

## Apply via Supabase Dashboard (RECOMMENDED)

1. Go to https://supabase.com/dashboard/project/agyjovdugmtopasyvlng
2. Navigate to **SQL Editor**
3. Click **+ New query**
4. Copy the entire contents of `20251116000001_enhance_product_integrations_tracking.sql`
5. Paste into the SQL editor
6. Click **Run** (or press Cmd/Ctrl + Enter)
7. Verify success message

## Apply via Supabase CLI (Alternative)

```bash
# Ensure you're logged in
npx supabase login

# Link to the project
npx supabase link --project-ref agyjovdugmtopasyvlng

# Apply pending migrations
npx supabase db push
```

## Apply via psql (Advanced)

```bash
# Connect to database
psql "postgresql://postgres:[PASSWORD]@[HOST]:5432/postgres"

# Run migration
\i supabase/migrations/20251116000001_enhance_product_integrations_tracking.sql
```

## Verify Migration Applied

Run this query in SQL Editor:

```sql
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'product_integrations'
  AND column_name LIKE 'zoho_%'
ORDER BY column_name;
```

You should see:
- `zoho_billing_hardware_item_id`
- `zoho_billing_item_id`
- `zoho_billing_last_sync_error`
- `zoho_billing_last_synced_at`
- `zoho_billing_plan_id`
- `zoho_billing_sync_status`
- `zoho_crm_last_sync_error`
- `zoho_crm_last_synced_at`
- `zoho_crm_product_id`
- `zoho_crm_sync_status`

Also verify functions were created:

```sql
SELECT routine_name
FROM information_schema.routines
WHERE routine_name IN ('record_rate_limit_hit', 'get_sync_candidates');
```

## What This Migration Does

1. **Adds separate CRM/Billing tracking columns** - Allows independent sync status for each system
2. **Adds rate limit monitoring** - Tracks when we hit rate limits
3. **Migrates existing data** - Copies old `sync_status` to new columns
4. **Creates helper functions** - `record_rate_limit_hit()` and `get_sync_candidates()`
5. **Maintains backward compatibility** - Old columns still work during transition

## Next Steps After Migration

1. Verify migration applied successfully
2. Update sync services to use new columns (already done in code)
3. Test with remaining 10 Billing packages
4. Monitor daily sync cron job at 02:00 SAST
5. In future: Remove deprecated columns (sync_status, last_synced_at, last_sync_error)
