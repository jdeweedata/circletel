/**
 * Test ZOHO Invoice Sync Service
 *
 * Tests syncing CircleTel manual invoices to ZOHO Billing
 * Usage: node scripts/test-zoho-invoice-sync.js [invoice_id]
 */

import 'dotenv/config';
import { createClient } from '@supabase/supabase-js';
import { syncInvoiceToZohoBilling, getInvoiceSyncStatus, findInvoicesNeedingSync } from '../lib/integrations/zoho/invoice-sync-service.js';

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

const SYNCABLE_INVOICE_TYPES = ['installation', 'pro_rata', 'equipment', 'adjustment'];

async function testInvoiceSync() {
  console.log('\n=== ZOHO Invoice Sync Test ===\n');

  try {
    // Get invoice ID from args or find a test invoice
    let invoiceId = process.argv[2];

    if (!invoiceId) {
      console.log('No invoice ID provided, finding test invoice...');

      // Try to find an invoice that needs syncing
      const needingSyncIds = await findInvoicesNeedingSync(1);

      if (needingSyncIds.length > 0) {
        invoiceId = needingSyncIds[0];
        console.log(`Found invoice needing sync: ${invoiceId}`);
      } else {
        // Get any syncable invoice for testing
        const { data: invoices } = await supabase
          .from('customer_invoices')
          .select('id, invoice_number, invoice_type, customer_id')
          .in('invoice_type', SYNCABLE_INVOICE_TYPES)
          .limit(1);

        if (!invoices || invoices.length === 0) {
          console.error('‚ùå No syncable invoices found in database');
          console.error('   Syncable types:', SYNCABLE_INVOICE_TYPES.join(', '));
          console.error('   Note: Recurring invoices are auto-generated by ZOHO from subscriptions');
          return;
        }

        invoiceId = invoices[0].id;
        console.log(`Using invoice: ${invoices[0].invoice_number} (${invoices[0].invoice_type})`);
      }
    }

    // Get invoice details before sync
    const { data: invoice } = await supabase
      .from('customer_invoices')
      .select(`
        *,
        customer:customers(*)
      `)
      .eq('id', invoiceId)
      .single();

    if (!invoice) {
      console.error('‚ùå Invoice not found:', invoiceId);
      return;
    }

    console.log('\nüìã Invoice Details:');
    console.log('  ID:', invoice.id);
    console.log('  Invoice Number:', invoice.invoice_number || 'N/A');
    console.log('  Type:', invoice.invoice_type);
    console.log('  Customer:', invoice.customer?.email || 'N/A');
    console.log('  Total Amount:', `R${invoice.total_amount || 0}`);
    console.log('  Invoice Date:', invoice.invoice_date || 'N/A');
    console.log('  Due Date:', invoice.due_date || 'N/A');
    console.log('  Status:', invoice.status || 'N/A');

    // Show line items
    if (invoice.line_items && Array.isArray(invoice.line_items)) {
      console.log('\n  Line Items:');
      invoice.line_items.forEach((item, idx) => {
        console.log(`    ${idx + 1}. ${item.name || item.description || 'Item'}`);
        console.log(`       Qty: ${item.quantity || 1}, Rate: R${item.price || item.rate || 0}`);
      });
    }

    console.log('\n  Current ZOHO Invoice ID:', invoice.zoho_billing_invoice_id || 'Not synced');
    console.log('  Sync Status:', invoice.zoho_sync_status || 'pending');

    // Check invoice type
    console.log('\nüîç Checking Invoice Type:');
    if (!SYNCABLE_INVOICE_TYPES.includes(invoice.invoice_type)) {
      console.error(`\n‚ùå ERROR: Invoice type '${invoice.invoice_type}' should not be synced!`);
      console.error('   Syncable types:', SYNCABLE_INVOICE_TYPES.join(', '));
      console.error('   Recurring invoices are auto-generated by ZOHO from subscriptions');
      return;
    }
    console.log('  ‚úÖ Invoice type is syncable:', invoice.invoice_type);

    // Check prerequisites
    console.log('\nüîç Checking Prerequisites:');

    // Check customer sync
    if (!invoice.customer?.zoho_billing_customer_id) {
      console.log('  ‚ö†Ô∏è  Customer not synced to ZOHO (will be synced automatically)');
      console.log('      Customer:', invoice.customer?.email);
    } else {
      console.log('  ‚úÖ Customer synced to ZOHO:', invoice.customer.zoho_billing_customer_id);
    }

    // Check if already synced
    if (invoice.zoho_billing_invoice_id) {
      console.log('\n‚ö†Ô∏è  Invoice already synced to ZOHO');
      console.log('   ZOHO Invoice ID:', invoice.zoho_billing_invoice_id);
      console.log('   Last Synced:', invoice.zoho_last_synced_at || 'N/A');

      const resync = process.argv.includes('--force');
      if (!resync) {
        console.log('\nüí° Use --force to re-sync');

        // Show current sync status
        const status = await getInvoiceSyncStatus(invoiceId);
        console.log('\nüìä Current Sync Status:', status);
        return;
      }

      console.log('\nüîÑ Force re-sync enabled, proceeding...');
      // Clear ZOHO ID to force re-sync
      await supabase
        .from('customer_invoices')
        .update({
          zoho_billing_invoice_id: null,
          zoho_sync_status: 'pending'
        })
        .eq('id', invoiceId);
    }

    // Perform sync
    console.log('\nüöÄ Starting sync to ZOHO Billing...');
    const startTime = Date.now();

    const result = await syncInvoiceToZohoBilling(invoiceId);

    const duration = Date.now() - startTime;
    console.log(`‚è±Ô∏è  Sync completed in ${duration}ms`);

    // Display results
    if (result.success) {
      console.log('\n‚úÖ Sync Successful!');
      console.log('   ZOHO Invoice ID:', result.zoho_invoice_id);

      // Get updated invoice data
      const { data: updatedInvoice } = await supabase
        .from('customer_invoices')
        .select('zoho_billing_invoice_id, zoho_sync_status, zoho_last_synced_at')
        .eq('id', invoiceId)
        .single();

      console.log('\nüìä Updated Invoice Record:');
      console.log('   ZOHO Invoice ID:', updatedInvoice.zoho_billing_invoice_id);
      console.log('   Sync Status:', updatedInvoice.zoho_sync_status);
      console.log('   Last Synced:', updatedInvoice.zoho_last_synced_at);

      // Get sync status
      const status = await getInvoiceSyncStatus(invoiceId);
      console.log('\nüìà Full Sync Status:', status);

      // Check sync logs
      const { data: logs } = await supabase
        .from('zoho_sync_logs')
        .select('*')
        .eq('entity_type', 'invoice')
        .eq('entity_id', invoiceId)
        .order('created_at', { ascending: false })
        .limit(1);

      if (logs && logs.length > 0) {
        console.log('\nüìù Latest Sync Log:');
        console.log('   Status:', logs[0].status);
        console.log('   Attempt:', logs[0].attempt_number);
        console.log('   Timestamp:', logs[0].created_at);
        if (logs[0].response_payload) {
          console.log('   Invoice Number:', logs[0].response_payload.invoice_number || 'N/A');
          console.log('   ZOHO Status:', logs[0].response_payload.status || 'N/A');
          console.log('   Total:', `R${logs[0].response_payload.total || 0}`);
        }
      }

    } else {
      console.error('\n‚ùå Sync Failed!');
      console.error('   Error:', result.error);

      // Get error details from database
      const { data: updatedInvoice } = await supabase
        .from('customer_invoices')
        .select('zoho_sync_status, zoho_last_sync_error')
        .eq('id', invoiceId)
        .single();

      console.error('\nüìä Invoice Record:');
      console.error('   Sync Status:', updatedInvoice.zoho_sync_status);
      console.error('   Error:', updatedInvoice.zoho_last_sync_error);
    }

  } catch (error) {
    console.error('\n‚ùå Test Error:', error);
    console.error('Stack:', error.stack);
  }
}

// Run test
testInvoiceSync()
  .then(() => {
    console.log('\n=== Test Complete ===\n');
    process.exit(0);
  })
  .catch(error => {
    console.error('\n‚ùå Fatal Error:', error);
    process.exit(1);
  });
