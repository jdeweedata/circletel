# ZOHO Billing Backfill Guide

Complete guide for syncing existing CircleTel data to ZOHO Billing.

## Overview

The backfill scripts sync existing production data from CircleTel to ZOHO Billing in the correct dependency order:

1. **Customers** â†’ Prerequisite for all other syncs
2. **Subscriptions** â†’ Requires customers to be synced
3. **Invoices** â†’ Requires customers to be synced
4. **Payments** â†’ Requires customers and invoices to be synced

## Prerequisites

### âœ… Before Running Backfill

1. **Database Cleanup Complete**
   - Run cleanup script: `node scripts/execute-test-data-cleanup.js`
   - Verify 13 production customers ready
   - Confirm `internal_test` accounts excluded

2. **ZOHO Billing Setup**
   - ZOHO Billing account created
   - Products/Plans published to ZOHO (via admin product catalog)
   - ZOHO API credentials configured in `.env.local`

3. **Environment Variables**
   ```bash
   NEXT_PUBLIC_SUPABASE_URL=https://agyjovdugmtopasyvlng.supabase.co
   SUPABASE_SERVICE_ROLE_KEY=<service_role_key>
   ZOHO_CLIENT_ID=<client_id>
   ZOHO_CLIENT_SECRET=<client_secret>
   ZOHO_REFRESH_TOKEN=<refresh_token>
   ZOHO_BILLING_ORGANIZATION_ID=<org_id>
   ```

4. **Test Customer Deleted from ZOHO**
   - Follow `docs/zoho/MANUAL_CLEANUP_GUIDE.md`
   - Delete ZOHO customer ID: `6179546000000820001`
   - Verify deletion before running backfill

## Quick Start

### Option 1: Master Orchestrator (Recommended)

Run all backfill scripts in sequence:

```bash
# Dry-run (test without syncing)
npm run zoho:backfill --dry-run

# Live sync (production)
npm run zoho:backfill
```

### Option 2: Individual Scripts

Run specific backfill scripts:

```bash
# Customers only (dry-run)
npm run zoho:backfill:customers --dry-run

# Customers (live)
npm run zoho:backfill:customers

# Subscriptions (dry-run)
npm run zoho:backfill:subscriptions --dry-run

# Subscriptions (live)
npm run zoho:backfill:subscriptions

# Invoices (live)
npm run zoho:backfill:invoices

# Payments (live)
npm run zoho:backfill:payments
```

## Backfill Scripts

### 1. Customer Backfill

**Script**: `scripts/zoho-backfill-customers.ts`

**What it does**:
- Fetches all production customers (excludes `internal_test` accounts)
- Syncs each customer to ZOHO Billing as a Contact
- Updates `zoho_billing_customer_id` in CircleTel database
- Logs all sync operations to `zoho_sync_logs` table

**Usage**:
```bash
npx tsx scripts/zoho-backfill-customers.ts [options]

Options:
  --dry-run       Simulate without syncing to ZOHO
  --batch-size=N  Process N customers per batch (default: 10)
```

**Expected Results**:
- 13 production customers synced
- 4 internal_test accounts skipped
- Each customer assigned ZOHO customer ID

---

### 2. Subscription Backfill

**Script**: `scripts/zoho-backfill-subscriptions.ts`

**What it does**:
- Fetches all active `customer_services`
- Creates ZOHO Billing Subscriptions for each service
- Links subscriptions to ZOHO customers and plan codes
- Updates `zoho_subscription_id` in CircleTel database

**Prerequisites**:
- Customers must be synced first
- Service packages must be published to ZOHO (via admin product catalog)

**Usage**:
```bash
npx tsx scripts/zoho-backfill-subscriptions.ts [options]

Options:
  --dry-run       Simulate without syncing
  --batch-size=N  Process N subscriptions per batch (default: 5)
```

---

### 3. Invoice Backfill

**Script**: `scripts/zoho-backfill-invoices.ts`

**What it does**:
- Fetches manual invoices (installation, pro_rata, equipment, adjustment)
- Creates ZOHO Billing Invoices
- **Note**: Recurring invoices are auto-generated by ZOHO from subscriptions

**Prerequisites**:
- Customers must be synced first

**Usage**:
```bash
npx tsx scripts/zoho-backfill-invoices.ts [options]

Options:
  --dry-run       Simulate without syncing
  --batch-size=N  Process N invoices per batch (default: 10)
```

**Invoice Types Synced**:
- `installation` - One-time installation fees
- `pro_rata` - Pro-rated service charges
- `equipment` - Equipment purchases
- `adjustment` - Account adjustments

**Invoice Types NOT Synced**:
- `recurring` - Auto-generated by ZOHO from subscriptions

---

### 4. Payment Backfill

**Script**: `scripts/zoho-backfill-payments.ts`

**What it does**:
- Fetches completed `payment_transactions`
- Records payments in ZOHO Billing
- Links payments to ZOHO invoices (if applicable)

**Prerequisites**:
- Customers must be synced first
- Invoices must be synced (if payment is for an invoice)

**Usage**:
```bash
npx tsx scripts/zoho-backfill-payments.ts [options]

Options:
  --dry-run       Simulate without syncing
  --batch-size=N  Process N payments per batch (default: 10)
```

---

### 5. Master Orchestrator

**Script**: `scripts/zoho-backfill-all.ts`

**What it does**:
- Runs all backfill scripts in correct dependency order
- Provides consolidated progress reporting
- Stops on critical failures (customer backfill)
- Continues after non-critical failures

**Usage**:
```bash
npx tsx scripts/zoho-backfill-all.ts [options]

Options:
  --dry-run              Simulate without syncing
  --skip-customers       Skip customer backfill
  --skip-subscriptions   Skip subscription backfill
  --skip-invoices        Skip invoice backfill
  --skip-payments        Skip payment backfill
```

**Examples**:
```bash
# Full backfill (dry-run)
npm run zoho:backfill --dry-run

# Full backfill (live)
npm run zoho:backfill

# Only subscriptions (customers already synced)
npm run zoho:backfill -- --skip-customers --skip-invoices --skip-payments

# Retry failed phases (skip successful ones)
npm run zoho:backfill -- --skip-customers
```

## Workflow

### Step 1: Pre-Backfill Checklist

- [ ] Database cleanup complete (`execute-test-data-cleanup.js`)
- [ ] Test customer deleted from ZOHO (ID: 6179546000000820001)
- [ ] Products/Plans published to ZOHO via admin catalog
- [ ] ZOHO API credentials verified
- [ ] Environment variables configured

### Step 2: Dry-Run Test

```bash
# Test full backfill
npm run zoho:backfill --dry-run
```

Review output for:
- Correct customer count (13 production)
- Internal test accounts excluded (4 skipped)
- No unexpected errors
- Dry-run completion message

### Step 3: Live Backfill

```bash
# Run live backfill
npm run zoho:backfill
```

Monitor output for:
- Successful customer sync (13/13)
- Successful subscription sync
- Invoice sync (if any manual invoices exist)
- Payment sync (if any completed payments exist)

### Step 4: Verification

1. **ZOHO Billing Dashboard**
   - Navigate to ZOHO Billing â†’ Customers
   - Verify 13 customers synced
   - Check subscription details
   - Verify invoices and payments

2. **CircleTel Admin Dashboard**
   - Navigate to `/admin/zoho-sync`
   - Check sync status summary
   - Review sync logs for any failures
   - Verify ZOHO IDs populated in database

3. **Database Verification**
   ```sql
   -- Check customer sync status
   SELECT
     COUNT(*) as total,
     COUNT(*) FILTER (WHERE zoho_billing_customer_id IS NOT NULL) as synced
   FROM customers
   WHERE account_type != 'internal_test';

   -- Check subscription sync status
   SELECT
     COUNT(*) as total,
     COUNT(*) FILTER (WHERE zoho_subscription_id IS NOT NULL) as synced
   FROM customer_services
   WHERE status = 'active';
   ```

### Step 5: Post-Backfill

- [ ] Verify all customers synced successfully
- [ ] Verify subscriptions created in ZOHO
- [ ] Check ZOHO Billing dashboard for data accuracy
- [ ] Monitor sync logs for any delayed failures
- [ ] Document any manual corrections needed

## Troubleshooting

### Error: "Customer not synced to ZOHO"

**Solution**: Run customer backfill first:
```bash
npm run zoho:backfill:customers
```

### Error: "Service package not synced to ZOHO Billing"

**Solution**: Publish products to ZOHO via admin product catalog:
1. Navigate to `/admin/products/catalog`
2. Select unpublished products
3. Click "Publish Selected to ZOHO"
4. Retry subscription backfill

### Error: "ZOHO API rate limit exceeded"

**Solution**: Reduce batch size:
```bash
npx tsx scripts/zoho-backfill-customers.ts --batch-size=5
```

### Error: "ZOHO customer already exists"

**Cause**: Email address already in ZOHO from previous sync

**Solution**: The sync service will automatically update the existing customer instead of creating a duplicate

### Some Syncs Failed

**Solution**: Retry individual failed entities:
```bash
# View failed syncs in admin dashboard
# Navigate to /admin/zoho-sync
# Click "Retry" button on failed syncs
```

Or use manual retry API:
```bash
curl -X POST http://localhost:3001/api/admin/zoho-sync/retry \
  -H "Content-Type: application/json" \
  -d '{"entity_type": "customer", "entity_id": "<customer_id>"}'
```

## Rate Limiting

The backfill scripts include built-in rate limiting to avoid overwhelming ZOHO API:

- **Between entities**: 500ms delay
- **Between batches**: 2 seconds delay
- **Default batch sizes**:
  - Customers: 10 per batch
  - Subscriptions: 5 per batch
  - Invoices: 10 per batch
  - Payments: 10 per batch

Adjust batch sizes if you encounter rate limit errors.

## Monitoring

### Real-Time Progress

Watch console output during backfill:
- âœ… Green checkmarks = Success
- â­ï¸ Blue arrow = Skipped (already synced or internal_test)
- âŒ Red X = Failed
- ðŸ” Magnifying glass = Dry-run

### Post-Backfill Analysis

1. **Admin Dashboard**: `/admin/zoho-sync`
   - Overall sync statistics
   - Recent sync activity
   - Failed sync list with retry buttons

2. **Database Logs**: Query `zoho_sync_logs` table
   ```sql
   SELECT
     entity_type,
     status,
     COUNT(*) as count
   FROM zoho_sync_logs
   WHERE created_at > NOW() - INTERVAL '1 hour'
   GROUP BY entity_type, status
   ORDER BY entity_type, status;
   ```

3. **ZOHO Billing Dashboard**
   - Verify customer count matches
   - Check subscription status
   - Review invoice amounts
   - Confirm payment records

## Best Practices

1. **Always Dry-Run First**
   ```bash
   npm run zoho:backfill --dry-run
   ```

2. **Monitor During Live Sync**
   - Watch console output for errors
   - Keep admin dashboard open (`/admin/zoho-sync`)
   - Monitor ZOHO Billing dashboard

3. **Verify After Completion**
   - Check all customers synced
   - Verify ZOHO IDs populated
   - Review sync logs for failures
   - Test ZOHO Billing dashboard

4. **Handle Failures Gracefully**
   - Don't panic if some syncs fail
   - Review error messages
   - Use retry functionality for failed entities
   - Contact support if persistent errors

## Support

### Common Issues

See [Troubleshooting](#troubleshooting) section above.

### Escalation

If you encounter persistent issues:

1. Check sync logs: `/admin/zoho-sync`
2. Review ZOHO API docs: https://www.zoho.com/billing/api/v1/
3. Check ZOHO Billing dashboard for error details
4. Review CircleTel integration docs: `docs/architecture/ADMIN_SUPABASE_ZOHO_INTEGRATION.md`

---

**Version**: 1.0
**Last Updated**: 2025-11-20
**Author**: Development Team + Claude Code
